<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>ぽみじく</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css">
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.7.0/js/dataTables.colReorder.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jsmigemo/dist/jsmigemo.min.mjs"></script> うごかん-->
    <script type="text/javascript" src='https://cdn.jsdelivr.net/npm/jsmigemo/dist/jsmigemo.js'></script>
    <style>
        input {
            height: 3em;
        }
        .dataTables_filter { visibility: hidden;}
    </style>
    
</head>

<body>
    <input id="custom-filter" class="form-control" placeholder="Search (powered by jsmigemo)" type="text" style="width:99%"/>
    <table id="dataTable" class="display" style="width:100%">
        <thead>
            <tr>
                <th>Lv</th>
                <!-- <th>Version</th> -->
                <th>Genre</th>
                <th>Title</th>
                <!-- <th>Min</th>
                <th>Max</th>
                <th>Time</th>
                <th>Notes</th> -->
                <th>Float</th>
                <th>Diff</th>
                <th>Attr</th>
                <th>Clear</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th>Lv</th>
                <!-- <th>Version</th> -->
                <th>Genre</th>
                <th>Title</th>
                <!-- <th>Min</th>
                <th>Max</th>
                <th>Time</th>
                <th>Notes</th> -->
                <th>Float</th>
                <th>Diff</th>
                <th>Attr</th>
                <th>Clear</th>
            </tr>
        </tfoot>
    </table>

    <script>
        // 指定されたURLからCSVデータを読み込み、DataTableに表示する
        function loadCsvAndDisplay(url) {
            Papa.parse(url, {
                download: true,
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function (results) {
                    console.log("CSV data:", results);
                    // jsmigemoの設定
                    var cd = null;
                    function loadDictionary() {
                        let req = new XMLHttpRequest();
                        req.open("get", "https://cdn.jsdelivr.net/npm/jsmigemo/migemo-compact-dict", true);
                        req.responseType = "arraybuffer";
                        req.onload = function () {
                            let ab = req.response;
                            cd = new jsmigemo.CompactDictionary(ab);
                        }
                        req.send(null);
                    }
                    $('#dataTable').DataTable({
                        data: results.data,
                        columns: results.meta.fields.map(function (field) {
                            return { data: field };
                        }),
                        colReorder: true,
                        footer: true,
                        initComplete: function () {
                            let api = this.api();
                            
                            // カスタム検索窓。元の検索窓は消さずにCSSで非表示にする（ヘッダ参照）
                            $('#custom-filter').keyup( function() {
                                var migemo = new jsmigemo.Migemo()
                                migemo.setDict(cd);
                                var reg = migemo.query(this.value);
                                api.search(reg, true).draw();
                            } );

                            api.columns().every(function () {
                                let column = this;
                                let title = column.header().title;
                                let th = column.header();

                                // Create input element
                                let input = document.createElement('input');
                                input.placeholder = title;
                                input.size = 5
                                th.replaceChildren(input);

                                // Event listener for user input
                                input.addEventListener('keyup', () => {
                                    if (column.search() !== this.value) {
                                        let idx = [...th.parentNode.children].indexOf(th);
                                        var migemo = new jsmigemo.Migemo()
                            			migemo.setDict(cd);
                                        var reg = migemo.query(input.value);
                                        // var regex = new RegExp(reg, 'g');
                                        api.column(idx + ':visible')
                                            .search(reg, true)
                                            .draw();
                                    }
                                });
                            });
                            loadDictionary();
                        }
                    });
                }
            });
        }

        // CSVファイルのURLを指定して関数を呼び出し
        loadCsvAndDisplay('view.csv');
        
    </script>
</body>

</html>